#!/bin/bash
# sprite-create-ssh: Create a sprite with SSH access configured

set -e

if [ -z "$1" ]; then
    echo "Usage: sprite-create-ssh <sprite-name>"
    exit 1
fi

SPRITE_NAME="$1"
SSH_PUB_KEY="$HOME/.ssh/id_ed25519.pub"
GITHUB_PRIV_KEY="$HOME/.ssh/sprite-github"
GITHUB_PUB_KEY="$HOME/.ssh/sprite-github.pub"

# Fallback to RSA if ed25519 doesn't exist
if [ ! -f "$SSH_PUB_KEY" ]; then
    SSH_PUB_KEY="$HOME/.ssh/id_rsa.pub"
fi

if [ ! -f "$SSH_PUB_KEY" ]; then
    echo "Error: No SSH public key found at ~/.ssh/id_ed25519.pub or ~/.ssh/id_rsa.pub"
    echo "Generate one with: ssh-keygen -t ed25519"
    exit 1
fi

if [ ! -f "$GITHUB_PRIV_KEY" ]; then
    echo "Warning: GitHub SSH key not found at $GITHUB_PRIV_KEY"
    echo "GitHub access from sprite will not be available."
    echo "Generate with: ssh-keygen -t ed25519 -f ~/.ssh/sprite-github"
fi

echo "Creating sprite: $SPRITE_NAME"
sprite create "$SPRITE_NAME"

echo "Setting $SPRITE_NAME as active sprite..."
sprite use "$SPRITE_NAME"

echo "Copying SSH public key to sprite..."
SSH_KEY_CONTENT=$(cat "$SSH_PUB_KEY")

# Create .ssh directory with correct permissions and add the public key
sprite exec -- bash -c "mkdir -p ~/.ssh && chmod 700 ~/.ssh"
sprite exec -- bash -c "echo '$SSH_KEY_CONTENT' >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys"

echo "Installing OpenSSH server and rsync on sprite..."
sprite exec -- bash -c "sudo apt-get update -qq && sudo apt-get install -y -qq openssh-server rsync"
sprite exec -- bash -c "sudo service ssh start"

# Copy GitHub private key if it exists
if [ -f "$GITHUB_PRIV_KEY" ]; then
    echo ""
    echo "Copying GitHub SSH private key..."
    GITHUB_KEY_CONTENT=$(cat "$GITHUB_PRIV_KEY")
    sprite exec -- bash -c "echo '$GITHUB_KEY_CONTENT' > ~/.ssh/sprite-github && chmod 600 ~/.ssh/sprite-github"

    echo "Configuring Git to use sprite-github key..."
    # Only add GitHub config if it doesn't already exist
    sprite exec -- bash -c "
        if ! grep -q 'Host github.com' ~/.ssh/config 2>/dev/null; then
            cat >> ~/.ssh/config << 'EOF'
Host github.com
    HostName github.com
    User git
    IdentityFile ~/.ssh/sprite-github
    IdentitiesOnly yes
EOF
            chmod 600 ~/.ssh/config
        fi
    "

    echo ""
    echo "GitHub SSH key installed!"
    echo "Add this public key to your GitHub account:"
    echo ""
    cat "$GITHUB_PUB_KEY"
    echo ""
fi

echo ""
echo "Sprite '$SPRITE_NAME' is ready!"
echo ""
echo "Available commands:"
echo "  sprite-copy <file>          Copy files to the sprite"
echo "  sprite-copy-to              Copy current directory to sprite home"
echo "  sprite-copy-from            Copy sprite home to current directory"
echo "  sprite console              Open interactive shell"
echo "  sprite exec <cmd>           Run a command on the sprite"
